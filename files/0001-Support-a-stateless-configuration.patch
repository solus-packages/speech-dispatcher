From 785d813b4f847c710c9dc8ce98d4f78e021a203b Mon Sep 17 00:00:00 2001
From: Martin Reboredo <yakoyoku@gmail.com>
Date: Tue, 1 Sep 2020 16:16:11 -0300
Subject: [PATCH] Support a stateless configuration

Signed-off-by: Martin Reboredo <yakoyoku@gmail.com>
---
 configure.ac         |  2 +-
 src/server/speechd.c | 15 ++++++++++-----
 2 files changed, 11 insertions(+), 6 deletions(-)

diff --git a/configure.ac b/configure.ac
index 896b69cd..5f654251 100644
--- a/configure.ac
+++ b/configure.ac
@@ -425,7 +425,7 @@ GETTEXT_PACKAGE=speech-dispatcher
 AC_SUBST([GETTEXT_PACKAGE])
 
 # Paths for configuration files:
-spdconfdir='${sysconfdir}/speech-dispatcher'
+spdconfdir='${datadir}/defaults/speech-dispatcher'
 AC_SUBST([spdconfdir])
 clientconfdir='${spdconfdir}/clients'
 AC_SUBST([clientconfdir])
diff --git a/src/server/speechd.c b/src/server/speechd.c
index 78457570..16d611f2 100644
--- a/src/server/speechd.c
+++ b/src/server/speechd.c
@@ -1083,12 +1083,17 @@ int main(int argc, char *argv[])
 			if (!g_file_test
 			    (test_speechd_conf_file, G_FILE_TEST_IS_REGULAR)) {
 				/* If the local configuration file doesn't exist, read the global configuration */
-				if (strcmp(SYS_CONF, ""))
+				if (g_file_test("/etc/speech-dispatcher", G_FILE_TEST_IS_DIR)) {
+					if (strcmp(SYS_CONF, ""))
+						SpeechdOptions.conf_dir =
+						g_strdup(SYS_CONF);
+					else
+						SpeechdOptions.conf_dir =
+						g_strdup("/etc/speech-dispatcher/");
+				} else {
 					SpeechdOptions.conf_dir =
-					    g_strdup(SYS_CONF);
-				else
-					SpeechdOptions.conf_dir =
-					    g_strdup("/etc/speech-dispatcher/");
+						g_strdup("/usr/share/defaults/speech-dispatcher/");
+				}
 			}
 			g_free(test_speechd_conf_file);
 		}
-- 
2.27.0

